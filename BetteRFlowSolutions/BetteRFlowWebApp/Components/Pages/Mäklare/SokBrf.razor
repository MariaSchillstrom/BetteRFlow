@page "/sok-brf"
@rendermode InteractiveServer

@using BetteRFlow.Shared.DTOs
@inject IHttpClientFactory ClientFactory
@inject IJSRuntime JS
@inject NavigationManager Navigator

<PageTitle>Sök BRF</PageTitle>

<div class="container mt-4">
    <h1>Sök BRF</h1>
    <p>Sök efter BRF:er som har skickat in formulär</p>

    <button class="btn btn-secondary mb-3" @onclick="LoadAllBrfs">
        Visa alla BRF:er
    </button>

    <div class="card mb-4">
        <div class="card-body">
            <div class="input-group">
                <input class="form-control"
                       placeholder="Sök på namn, fastighet eller org.nr"
                       @bind="searchTerm"
                       @bind:event="oninput" />
                <button class="btn btn-primary" @onclick="HandleSearch">
                    Sök
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border"></div>
        </div>
    }

    @if (!isLoading && searchResults != null && searchResults.Any())
    {
        <h4>Resultat (@searchResults.Count st)</h4>

        <div class="row">
            @foreach (var brf in searchResults)
            {
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>@brf.ForeningensNamn</h5>

                            <p>
                                <strong>Fastighet:</strong> @brf.Fastighetsbeteckning<br />
                                <strong>Org.nr:</strong> @brf.OrganisationsNummer<br />
                                <strong>Byggnadsår:</strong> @brf.Byggnadsår<br />
                                <strong>Antal lägenheter:</strong> @brf.AntalLägenheter
                            </p>

                            <button class="btn btn-info me-2" @onclick="() => ShowDetails(brf)">
                                Visa detaljer
                            </button>

                            <button class="btn btn-success" @onclick="() => Purchase(brf)">
                                Köp uppgifter
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!isLoading && hasSearched)
    {
        <div class="alert alert-info">
            Inga BRF:er hittades.
        </div>
    }

    @if (selectedBrf != null)
    {
        <div class="modal show d-block" style="background: rgba(0,0,0,.5)">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@selectedBrf.ForeningensNamn</h5>
                        <button class="btn-close" @onclick="CloseDetails"></button>
                    </div>

                    <div class="modal-body">
                        <p>
                            <strong>Fastighetsbeteckning:</strong> @selectedBrf.Fastighetsbeteckning<br />
                            <strong>Adress:</strong> @selectedBrf.Gatuadress<br />
                            <strong>Postort:</strong> @selectedBrf.Postnummer @selectedBrf.Ort<br />
                            <strong>Email:</strong> @selectedBrf.KontaktEmail<br />
                            <strong>Telefon:</strong> @selectedBrf.KontaktTelefon
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseDetails">
                            Stäng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string searchTerm = "";
    private List<FormDto>? searchResults;
    private FormDto? selectedBrf;
    private bool isLoading = false;
    private bool hasSearched = false;

    private async Task LoadAllBrfs()
    {
        isLoading = true;
        hasSearched = true;

        try
        {
            var http = ClientFactory.CreateClient("ApiClient");
            searchResults = await http.GetFromJsonAsync<List<FormDto>>("api/formsubmission");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSearch()
    {
        isLoading = true;
        hasSearched = true;

        try
        {
            var http = ClientFactory.CreateClient("ApiClient");
            searchResults = await http.GetFromJsonAsync<List<FormDto>>(
                $"api/formsubmission/search?searchTerm={searchTerm}");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowDetails(FormDto brf)
    {
        selectedBrf = brf;
    }

    private void CloseDetails()
    {
        selectedBrf = null;
    }

    private void Purchase(FormDto brf)
    {
        Navigator.NavigateTo($"/purchase-brf/{brf.Id}");
    }
}
