@page "/maklare"
@rendermode InteractiveServer
@using System.Text.Json
@using BetteRFlow.Shared.DTOs
@inject IJSRuntime JS
@inject HttpClient Http

<PageTitle>Mäklare</PageTitle>

<div class="container mt-4">
    @if (!string.IsNullOrEmpty(userName))
    {
        <div class="alert alert-success">
            <strong>Välkommen @userName!</strong> Du är inloggad som mäklare.
        </div>
    }

    <h1>Mäklarsida</h1>
    <p>Sök efter BRF:er i systemet</p>

    <button class="btn btn-secondary mb-3" @onclick="LoadAllBrfs">Visa alla BRF:er</button>

    @* SÖKRUTA *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="input-group">
                <input type="text"
                       class="form-control"
                       placeholder="Sök på BRF-namn, fastighet eller organisationsnummer..."
                       @bind="searchTerm"
                       @bind:event="oninput" />
                <button class="btn btn-primary" @onclick="HandleSearch">
                    Sök
                </button>
            </div>
        </div>
    </div>

    @* LADDNINGSINDIKATOR *@
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Laddar...</span>
            </div>
        </div>
    }

    @* RESULTAT *@
    @if (searchResults != null && searchResults.Any())
    {
        <h3>Sökresultat (@searchResults.Count st)</h3>
        <div class="row">
            @foreach (var brf in searchResults)
            {
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">@brf.BrfNamn</h5>
                            <p class="card-text">
                                <strong>Fastighet:</strong> @brf.Fastighet<br />
                                <strong>Org.nr:</strong> @brf.Organisationsnummer<br />
                                <strong>Antal lägenheter:</strong> @brf.AntalLägenheter<br />
                                <strong>Byggnadsår:</strong> @brf.Byggnadsår
                            </p>
                            <button class="btn btn-info" @onclick="() => ShowDetails(brf)">
                                Visa detaljer
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (!isLoading && hasSearched)
    {
        <div class="alert alert-info">
            Inga BRF:er hittades.
        </div>
    }

    @* DETALJVY *@
    @if (selectedBrf != null)
    {
        <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@selectedBrf.BrfNamn - Detaljer</h5>
                        <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Grunduppgifter</h6>
                        <p>
                            <strong>Fastighet:</strong> @selectedBrf.Fastighet<br />
                            <strong>Organisationsnummer:</strong> @selectedBrf.Organisationsnummer<br />
                            <strong>Byggnadsår:</strong> @selectedBrf.Byggnadsår<br />
                            <strong>Antal lägenheter:</strong> @selectedBrf.AntalLägenheter<br />
                            <strong>Äkta BRF:</strong> @(selectedBrf.ÄktaBrf ? "Ja" : "Nej")
                        </p>

                        <h6 class="mt-3">Förvaltning</h6>
                        <p>
                            <strong>Ekonomisk förvaltare:</strong> @selectedBrf.EkonomiskFörvaltare<br />
                            <strong>Fastighetsförvaltare:</strong> @selectedBrf.FastighetsFörvaltare
                        </p>

                        <h6 class="mt-3">Kontakt</h6>
                        <p>
                            <strong>Email:</strong> @selectedBrf.KontaktEmail<br />
                            <strong>Telefon:</strong> @selectedBrf.KontaktTelefon<br />
                            <strong>Hemsida:</strong> @selectedBrf.Hemsida
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDetails">Stäng</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string userName = "";
    private string userEmail = "";
    private string userRole = "";

    private string searchTerm = "";
    private List<FormDto>? searchResults = null;
    private FormDto? selectedBrf = null;
    private bool isLoading = false;
    private bool hasSearched = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var userJson = await JS.InvokeAsync<string>("localStorage.getItem", "user");
                if (!string.IsNullOrEmpty(userJson))
                {
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    var user = JsonSerializer.Deserialize<Dictionary<string, string>>(userJson, options);
                    if (user != null)
                    {
                        userName = user.ContainsKey("name") ? user["name"] : "";
                        userEmail = user.ContainsKey("email") ? user["email"] : "";
                        userRole = user.ContainsKey("role") ? user["role"] : "";
                        await InvokeAsync(StateHasChanged);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Fel: {ex.Message}");
            }
        }
    }

    private async Task HandleSearch()
    {
        isLoading = true;
        hasSearched = true;

        try
        {
            var response = await Http.GetAsync($"api/formsubmission/search?searchTerm={searchTerm}");

            if (response.IsSuccessStatusCode)
            {
                searchResults = await response.Content.ReadFromJsonAsync<List<FormDto>>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Sökfel: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowDetails(FormDto brf)
    {
        selectedBrf = brf;
    }

    private void CloseDetails()
    {
        selectedBrf = null;
    }

    private async Task LoadAllBrfs()
    {
        isLoading = true;
        hasSearched = true;
        searchTerm = "";

        try
        {
            var response = await Http.GetAsync("api/formsubmission/search");

            if (response.IsSuccessStatusCode)
            {
                searchResults = await response.Content.ReadFromJsonAsync<List<FormDto>>();
                await JS.InvokeVoidAsync("console.log", $"Hittade {searchResults?.Count ?? 0} BRF:er");
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", "Fel vid hämtning:", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.log", "Exception:", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }
}