# 5. Applikationens komponenter

#### 5.1 Backend (BetteRFlowWebAPI)

**Controllers**

**AuthController**

* `POST /api/auth/register` - Registrera ny användare
* `POST /api/auth/login` - Logga in användare
* Validerar input
* Hashar lösenord med BCrypt
* Returnerar användardata (utan lösenord)

**UserController**

* `GET /api/user/{id}` - Hämta användare
* `GET /api/user` - Hämta alla användare
* `PUT /api/user/{id}` - Uppdatera användare
* `DELETE /api/user/{id}` - Ta bort användare

**BrfController**

* `GET /api/brf/{id}` - Hämta BRF
* `GET /api/brf` - Hämta alla BRF:er
* `POST /api/brf` - Skapa ny BRF
* `PUT /api/brf/{id}` - Uppdatera BRF

**FormSubmissionController** (under utveckling)

* `POST /api/formsubmission` - Skicka in ifyllt formulär
* `GET /api/formsubmission/{fastighetId}` - Hämta formulärdata



#### 5.1 Viktiga funktioner

**Data Validation**

Exempel från RegisterDto.cs

```csharp
public class RegisterDto
{
    [Required(ErrorMessage = "Email är obligatoriskt")]
    [EmailAddress(ErrorMessage = "Ogiltig email-format")]
    public string Email { get; set; }

    [Required(ErrorMessage = "Användarnamn är obligatoriskt")]
    [MinLength(3, ErrorMessage = "Användarnamn måste vara minst 3 tecken")]
    public string Username { get; set; }

    [Required(ErrorMessage = "Lösenord är obligatoriskt")]
    [MinLength(6, ErrorMessage = "Lösenord måste vara minst 6 tecken")]
    public string Password { get; set; }

    [Required(ErrorMessage = "Roll är obligatorisk")]
    public UserRole Role { get; set; }
}
```

**CORS-konfiguration**

Program.cs - tillåter frontend att kommunicera med backend

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowBlazorClient", policy =>
    {
        policy.WithOrigins("https://localhost:7026")
              .AllowAnyHeader()
              .AllowAnyMethod();
    });
});
```

**Entity Framework Configuration**

Program.cs - databaskoppling

```csharp
builder.Services.AddDbContext<BetteRFlowContext>(options =>
    options.UseSqlite(
        builder.Configuration.GetConnectionString("DefaultConnection")
    )
);
```

#### 5.3 Frontend (BetteRFlowWebApp)

**Huvudsidor**

**Register.razor**

* Registreringsformulär med MudBlazor-komponenter
* Rollval (BRF-medlem eller Mäklare)
* Validering i realtid
* Kommunicerar med `POST /api/auth/register`

**Login.razor**

* Inloggningsformulär
* Email och lösenord
* Kommunicerar med `POST /api/auth/login`
* Omdirigering efter lyckad inloggning

**BrfForm.razor** (under utveckling)

* Formulär med \~100 frågor om fastigheten
* BRF-medlemmar fyller i information
* Data skickas till backend vid submit

**Komponenter**

* **MudBlazor-komponenter** för formulär
* **Validering** via EditForm och ValidationSummary
* **HttpClient** för API-kommunikation

#### 5.4 Databas

**Databasmodeller**

**User** - Användarkonton

```csharp
public class User
{
    public int Id { get; set; }
    public string Fornamn { get; set; }
    public string Efternamn { get; set; }
    public string Email { get; set; }
    public string PasswordHash { get; set; }
    public UserRole Role { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public bool IsActive { get; set; }
    public DateTime? LastLogin { get; set; }
    
    // För BRF-användare:
    public int? BrfId { get; set; }
    public Brf? Brf { get; set; } // Navigation property//
    
    // För mäklare:
    public string? Firma { get; set; }
    public int? RealtorId { get; set; }
    public Realtor? Realtor { get; set; } // Navigation property//
}
```

**Brf** - Bostadsrättsföreningar

```csharp
public class Brf
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string OrganizationNumber { get; set; }
    public string Address { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // Navigation properties
    public ICollection<User> Members { get; set; }
}
```

**Form** - Formulärmetadata

```csharp
public class Form
{
    public int Id { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}
```

**Notering:** De faktiska formulärfrågorna (\~100 frågor) är hårdkodade i Blazor-komponenten för denna fas. I framtida versioner kan formulären göras dynamiska.



**Entity Relationship Diagram**



<div align="left"><figure><img src="../.gitbook/assets/image (9).png" alt="" width="375"><figcaption></figcaption></figure></div>

ER-diagrammet visar systemets databasstruktur och hur tabellerna är relaterade till varandra.

**Tabeller:**

**User** - Innehåller alla användare i systemet

* Både BRF-medlemmar och mäklare lagras i samma tabell
* Rollbaserad separation via `Role`-fältet
* BRF-medlemmar har ett `BrfId` som kopplar dem till en specifik BRF
* Mäklare har ett `Firma`-fält och eventuellt `RealtorId`

**Brf** - Representerar bostadsrättsföreningar

* Lagrar grundläggande information om föreningen
* Kopplas till flera användare (styrelsemedlemmar)

**Form** - Metadata om formuläret

* Spårar när formulär skapades och uppdaterades
* De faktiska frågorna (100+ fält) är hårdkodade i frontenden

**Relationer:**

**User → Brf (N:1)**

* Flera användare kan tillhöra samma BRF
* En BRF kan ha flera styrelsemedlemmar registrerade
* Detta möjliggör att flera personer i samma styrelse kan ha åtkomst
* Koppling via `BrfId` foreign key i User-tabellen

**Design-beslut:**

Formulärfrågorna lagras för närvarande inte i databasen utan är hårdkodade i Blazor-komponenten.&#x20;

#### 5.4 Shared Library

**Models** - Databasmodeller med navigation properties

* Används av både backend (Entity Framework) och frontend
* Innehåller valideringslogik
* Navigation properties för relationer

**DTOs (Data Transfer Objects)** - Säker dataöverföring

* Filtrerar bort känslig information (t.ex. PasswordHash)
* Innehåller valideringsattribut
* Används för API-kommunikation

Exempel på DTO:

```csharp
public class UserDto
{
    public int Id { get; set; }
    public string Fornamn { get; set; }
    public string Efternamn { get; set; }
    public string Email { get; set; }
    public UserRole Role { get; set; }
    public DateTime CreatedAt { get; set; }
    // Notera: PasswordHash finns INTE här av säkerhetsskäl
}
```

**Enums** - Uppräkningstyper

```csharp
public enum UserRole
{
    BrfMember,
    Maklare,
    Admin
}
```

