# 10. Problem & lösningar



En omfattande felsökningssession där det var problem med projektstruktur, Git-hantering, migrations, och skapade en stabil `devnew`-gren som ny huvudgren.

### &#x20;1. Dubbla projektmappar och förvirrande struktur

#### Problem:

* Projektet hade dubbla mappar för samma projekt
* `BetterFlowWebAPI` (utan R) OCH `BetteRFlowWebAPI` (med R) fanns
* Solution-filen pekade på `BetteRFlowSolutions/BetteRFlowWebAPI/` men vi jobbade i `BetteRFlow/BetterFlowWebAPI/`
* Visual Studio öppnade fel mappar vid "Open in File Explorer"

#### Lösning:

1. Fixade Solution-filen att peka på rätt sökvägar
2. Döpte om `BetterFlowWebAPI` → `BetteRFlowWebAPI` för konsistens
3. Skapade mapp `används-inte/` och flyttade gamla dubbletter dit
4. Verifierade att Solution använder rätt mappar: `BetteRFlowSolutions/BetteRFlowWebAPI/` och `BetteRFlowSolutions/BetteRFlowWebApp/`

### &#x20;2.  WebApp-projektet försvann från Solution

#### Problem:

* Efter Solution-fixar visades BetteRFlowWebApp som "(not found)" i Solution Explorer
* Kunde inte lägga till projektet via "Add Existing Project"
* Visual Studio cachade gammal mappstruktur

#### Lösning:

1. Stängde Visual Studio
2. Tog bort `.vs/` mappen (Visual Studio cache)
3. Öppnade Visual Studio igen
4. Lade till WebApp via "Add Existing Project" → navigerade direkt till rätt .csproj

***

### 3. Connection string försvann upprepade gånger

#### Problem:

* `appsettings.Development.json` blev tom eller förlorade ConnectionStrings-sektionen
* Hände varje gång vi bytte grenar eller körde git-kommandon
* Projektet kunde inte köras utan connection string

#### Lösning:

Återskapade connection string varje gång:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=betterflow.db"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}

```

**Rot-orsak:** Filen modifierades av Git vid branch-byten eftersom den inte var korrekt committad.

***

### 4. Databas-fil (betterflow.db) dök upp som ändring hela tiden

#### Problem:

* `betterflow.db` visades som "uncommitted file" i Git Changes vid varje körning
* Försök att ta bort med `git rm --cached` misslyckades
* Blockerade branch-byten med konfliktdialog

#### Lösning:

1. **Uppdaterade `.gitignore`:**

```
# SQLite databases
*.db
*.db-shm
*.db-wal

```

1. **Försökte ta bort från tracking:**

```bash
git rm --cached BetteRFlowSolutions/BetteRFlowWebAPI/betterflow.db

```

1. **Resultat:** Filen markerades som "Untracked" istället för "Modified", vilket är okej eftersom `.gitignore` förhindrar commit

**Viktigt:** Databasen kommer alltid synas lite i Git Changes men den commitas ALDRIG tack vare `.gitignore`.

***

### 5. Git-gren "dev" fungerade inte

#### Problem:

* Den gamla `dev`grenen var trasig
* Försök att merga eller byta till den gav fel
* Connection string och migrations fungerade inte på `dev`

#### Lösning:

**Skapade ny huvudgren `devnew`:**

1. **På GitHub:** Döpte om `Fix-appsetting.json-med-connection` → `devnew`
2. **Lokalt:**

```bash
git checkout Fix-appsetting.json-med-connection
git branch -m devnew
git fetch origin
git branch --set-upstream-to=origin/devnew devnew

```

1. **Flyttade gamla mappar och committade:**

```bash
git add .
git commit -m "Skapa devnew som ny huvudgren och städa mappstruktur"
git push origin devnew

```

**Resultat:** `devnew` är nu stabil huvudgren, gamla `dev` ignoreras.

***

### 6. Form.cs hade fel namespace

#### Problem:

* Form.cs användes namespace `BetteRFlowShared.Models` (utan punkt mellan BetteRFlow och Shared)
* Gav kompileringsfel: `CS0246: The type or namespace name 'Form' could not be found`
* BetteRFlowContext.cs kunde inte hitta Form-klassen

#### Symptom:

```
Error CS0246: The type or namespace name 'Form' could not be found
(are you missing a using directive or an assembly reference?)

```

#### Lösning:

Fixade namespace i Form.cs:

```csharp
// FÖRE (fel):
namespace BetteRFlowShared.Models;

// EFTER (rätt):
namespace BetteRFlow.Shared.Models;

```

**Viktigt:** Alla filer i BetteRFlow.Shared-projektet ska använda `BetteRFlow.Shared.X` som namespace.

***

### 7. Migrations fungerade inte från Shared-projektet

#### Problem:

När vi försökte köra migrations:

```powershell
Add-Migration UpdateFormNamespace -Project BetteRFlow.Shared

```

Fick vi fel:

```
Unable to create a 'DbContext' of type 'RuntimeType'.
The exception 'Unable to resolve service for type
'Microsoft.EntityFrameworkCore.DbContextOptions`1[BetteRFlow.Shared.Data.BetteRFlowContext]'
while attempting to activate 'BetteRFlow.Shared.Data.BetteRFlowContext'.' was thrown

```

#### Orsak:

* Migrations ligger i **BetteRFlow.Shared** (ett class library)
* Class libraries har ingen `Program.cs` eller `appsettings.json`
* Entity Framework visste inte hur man skapar DbContext för migrations

#### Lösning:

**Skapade `DesignTimeDbContextFactory.cs`:**

Fil: `BetteRFlow.Shared/Data/DesignTimeDbContextFactory.cs`

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Design;

namespace BetteRFlow.Shared.Data;

public class DesignTimeDbContextFactory : IDesignTimeDbContextFactory<BetteRFlowContext>
{
    public BetteRFlowContext CreateDbContext(string[] args)
    {
        var optionsBuilder = new DbContextOptionsBuilder<BetteRFlowContext>();
        optionsBuilder.UseSqlite("Data Source=betterflow.db");

        return new BetteRFlowContext(optionsBuilder.Options);
    }
}

```

**Vad den gör:**

* Instruerar Entity Framework hur man skapar DbContext vid design time (när migrations körs)
* Anger connection string direkt i koden för migrations
* Standard best practice för class libraries med EF Core

**Efter detta fungerade migrations perfekt:**

```powershell
Add-Migration AddFormFields -Project BetteRFlow.Shared
Update-Database -Project BetteRFlow.Shared

```

***

### 8. Database Update-varning om transaction

#### Varning vid Update-Database:

```
The migration operation 'PRAGMA foreign_keys = 0;' from migration 'AddFormFields'
cannot be executed in a transaction. If the app is terminated or an unrecoverable error
occurs while this operation is being executed then the migration will be left in a
partially applied state and would need to be reverted manually before it can be applied again.

```

#### Förklaring:

* Detta är en **SQLite-specifik varning**
* INTE ett fel - migrations kördes framgångsrikt ("Done.")
* SQLite hanterar foreign keys annorlunda än SQL Server/PostgreSQL
* Vissa operationer kan inte köras i transaktioner

**Inget att göra - det är normalt för SQLite!**

***

### 9. Register.razor syntax-fel i catch-block

#### Problem:

Efter att ha lagt till NavigationException-hantering fick vi fel:

```
Error CS0841: Cannot use local variable 'registerModel' before it is declared

```

#### Orsak:

Catch-blocket saknade måsvingar och finally-block:

```csharp
// FEL:
catch (Microsoft.AspNetCore.Components.NavigationException)  // <- INGA {}
 catch (Exception ex)  // <- Syntax-fel
 {
    errorMessage = $"Ett fel uppstod: {ex.Message}";
}

```

#### Lösning:

```csharp
// RÄTT:
catch (Microsoft.AspNetCore.Components.NavigationException)
{
    // NavigationException är normalt vid NavigateTo() - ignorera
}
catch (Exception ex)
{
    errorMessage = $"Ett fel uppstod: {ex.Message}";
}
finally
{
    isSubmitting = false;
}

```

**Lärdomar:**

* Alla catch-block måste ha måsvingar `{ }`
* Använd finally för cleanup-kod (som att återställa `isSubmitting`)

***

### 10. GitBook synkar inte med devnew

#### Problem:

* GitBook var konfigurerad att synka med grenen `dev`
* Vi bytte till `devnew` som ny huvudgren
* GitBook visade gamla ändringar eller ingenting

#### Lösning:

Uppdaterade GitBook-inställningar att synka med `devnew` istället för `dev`.

**Varför inte byta namn på devnew → dev?** Valde att INTE byta namn i VS/Git eftersom allt fungerade perfekt lokalt. Enklare att uppdatera GitBook en gång än att riskera nya Git-problem.

***

### Sammanfattning av lösningar

#### Package Manager Console inställningar (VIKTIGA):

* **Default project:** BetteRFlowWebAPI
* **Migrations-kommandon:**

```powershell
Add-Migration <Name> -Project BetteRFlow.Shared
Update-Database -Project BetteRFlow.Shared

```

#### Visual Studio Startup Projects:

* **Multiple Startup Projects:**
  * BetteRFlowWebAPI: Start
  * BetteRFlowWebApp: Start
  * BetteRFlow.Shared: None

#### Git-struktur:

* **Huvudgren:** `devnew` (ersätter trasiga `dev`)
* **Feature branches:** Skapas från `devnew`
* **Databas:** Ignoreras av `.gitignore`

#### Namngivningskonventioner:

* **Namespace:** Alltid `BetteRFlow.Shared.X` (med punkt mellan BetteRFlow och Shared)
* **Mappar:** Konsistent `BetteRFlow` med stort R

***

### Viktiga lärdomar

#### 1. DesignTimeDbContextFactory är nödvändig

När migrations ligger i ett class library (Shared) behövs en factory för att EF ska kunna skapa DbContext vid design time.

#### 2. .gitignore för databaser

Databas-filer ska ALLTID ignoreras:

```
*.db
*.db-shm
*.db-wal

```

#### 3. Namespace-konsekvens

Alla filer i ett projekt MÅSTE använda samma namespace-format. Blandning av `BetteRFlowShared` och `BetteRFlow.Shared` ger kompileringsfel.

#### 4. Solution-filer är känsliga

.sln-filer innehåller exakta sökvägar till projekt. Om mappar flyttas måste .sln uppdateras manuellt eller projekt läggas till igen.

#### 5. Git branch-hantering

När en gren är trasig - skapa ny istället för att försöka fixa. Det är snabbare och säkrare.

#### 6. Visual Studio cache

Vid konstiga problem där VS "inte ser" ändringar:

1. Stäng VS
2. Ta bort `.vs/` mappen
3. Starta om VS

***

### Slutstatus

#### ✅ Fungerande struktur:

* devnew-gren som är stabil och fungerande
* Korrekt mappstruktur utan dubbletter
* Form.cs med alla BRF-fält
* Migrations fungerar korrekt
* Registrering fungerar (WebApp → API → Databas)
* GitBook synkar med devnew

#### ✅ Commits gjorda:

1. "Ignorera SQLite-databasfiler och ta bort befintlig databas från Git"
2. "Flytta oanvända mappar till används-inte"
3. "Fixa namespace i Form.cs"
4. "Lägg till DesignTimeDbContextFactory och komplett Form.cs"
5. "Fixa syntax-fel i Register.razor catch-block"

### Teknisk referens

#### Connection String (appsettings.Development.json):

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=betterflow.db"
  }
}

```

#### Migration-kommandon:

```powershell
# Skapa ny migration
Add-Migration <MigrationName> -Project BetteRFlow.Shared

# Applicera migrations
Update-Database -Project BetteRFlow.Shared

# Se pending migrations
dotnet ef migrations list --project BetteRFlow.Shared

```

#### Git-kommandon som använts:

```bash
# Byt gren
git checkout <branch-name>

# Skapa ny gren från nuvarande
git checkout -b <new-branch>

# Döp om gren
git branch -m <old-name> <new-name>

# Ta bort fil från tracking (men behåll lokalt)
git rm --cached <file-path>

# Återställ alla ändringar
git reset --hard HEAD

# Städa untracked filer
git clean -fdx

```



### Kontaktpunkter för framtida problem

#### Om migrations slutar fungera:

1. Kontrollera att DesignTimeDbContextFactory finns i BetteRFlow.Shared/Data/
2. Verifiera att Default project är BetteRFlowWebAPI i Package Manager Console
3. Använd alltid `Project BetteRFlow.Shared` i migration-kommandon

#### Om databas-ändringar inte syns:

1. Kör `Update-Database -Project BetteRFlow.Shared`
2. Rebuild Solution
3. Kör projektet på nytt

#### Om namespace-fel uppstår:

1. Alla filer i BetteRFlow.Shared ska ha `namespace BetteRFlow.Shared.X;`
2. Använd Find & Replace för att fixa alla filer på en gång
3. Rebuild efter ändring

#### Om Git-grenar strular:

1. Skapa alltid nya feature branches från devnew
2. Vid problem - skapa ny gren istället för att fixa trasig
3. Stash eller discard betterflow.db vid branch-byten

## Övriga ändringar (problem)- BetteRFlow

**Lagt till databas-migrering i `Program.cs` så att databasen skapas automatiskt när API:et startar.**

```csharp
{
    var db = scope.ServiceProvider.GetRequiredService<BetteRFlowContext>();
    db.Database.Migrate(); // Kör alla pending migrations automatiskt
}
```

**Lagt till specifik catch för `NavigationException` före den generella catch-blocket.**

**Problem:** Efter lyckad registrering visas felmeddelande: "Ett fel uppstod: Exception of type 'Microsoft.AspNetCore.Components.NavigationException' was thrown."

**Orsak:** `NavigationException` är Blazors sätt att stoppa exekvering vid `NavigateTo()`. Det är inte ett verkligt fel, men catch-blocket fångar det som ett exception.

**Fil:** `BetteRFlowSolutions/BetteRFlowWebApp/Components/Pages/Register.razor`

```csharp
catch (Microsoft.AspNetCore.Components.NavigationException)
{
    // NavigationException är normalt vid NavigateTo() - ignorera
}
catch (Exception ex)
{
    errorMessage = $"Ett fel uppstod: {ex.Message}";
}
```

**Lagt till `FormName` attribute på `EditForm` och `SupplyParameterFromForm` på model property.**

**Problem:** Blank page med felmeddelande: "The POST request does not specify which form is being submitted. To fix this, ensure

elements have a @formname attribute..."

**Orsak:** Blazor SSR (Server-Side Rendering) i .NET 8+ kräver unika FormName för alla formulär för att kunna routa POST requests korrekt.

**Fil:** `BetteRFlowSolutions/BetteRFlowWebApp/Components/Pages/Login.razor`

```csharp
<EditForm Model="@loginModel" OnValidSubmit="@HandleLogin" FormName="LoginForm">
```

```csharp
[SupplyParameterFromForm(FormName = "LoginForm")]
private LoginDto loginModel { get; set; } = new();
```

**Fix dynamisk Firma-fält visning vid dropdown-ändring**

**Problem:** När användaren väljer "Mäklare" i dropdown visas inte "Firma"-fältet förrän efter submit eller page refresh.

**Orsak:** Blazor SSR använder `onchange` som default event för `InputSelect`, vilket endast triggar vid blur (när man klickar utanför). Conditional rendering (`@if`) uppdateras därför inte direkt.

**Lösning:** Lägg till `@bind-Value:event="oninput"` för att trigga re-render vid varje dropdown-ändring.

**Fil:** `BetteRFlowSolutions/BetteRFlowWebApp/Components/Pages/Register.razor`

```razor
<InputSelect @bind-Value="registerModel.Role" @bind-Value:event="oninput" class="form-select" id="role">
```
